name: nezha-kernel
type: kernel
build-base: core24
adopt-info: kernel
summary: An Ubuntu Core kernel for the RISC-V AllWinner Nezha
description: |
  This snap provides the kernel, modules, firmware, and initrd required to
  create an Ubuntu Core image for the RISC-V AllWinner Nezha.

  The kernel and initrd are provided as a single universal kernel image file
  which is then booted by the managed assets created and owned by snapd.
  Generally, this snap would also provide the device tree files for the target
  hardware. However, in this case, that device tree is provided by the u-boot
  binary in our gadget snap. If we needed it here, we could likewise add that
  file to our UKI.

  ** Note that the license information for this snap is incomplete **
  Do your due diligence to ensure compliance with the licenses of the contents of this snap.

  This snapcraft.yaml is licensed under CC-BY-SA-4.0

  You can find any and all licenses for the contents of this snap at the following locations:

  linux-firmware: https://git.launchpad.net/ubuntu/+source/linux-firmware/tree/?h=applied/ubuntu/noble
  kernel:         https://git.launchpad.net/~canonical-kernel/ubuntu/+source/linux-riscv/+git/noble/

  All provided: licenses/

grade: stable
confinement: strict

license: "GPL-2.0 AND GPL-3.0 AND CC-BY-SA-4.0"
website: https://github.com/canonical/iot-field-kernel-snap
issues: https://github.com/canonical/iot-field-kernel-snap/issues

platforms:
  riscv64:
    build-on:  [amd64]
    build-for: [riscv64]

package-repositories:
  - type: apt
    components: [main]
    architectures: [$CRAFT_ARCH_BUILD_FOR]
    suites: [noble]
    key-id: F6ECB3762474EDA9D21B7022871920D1991BC93C
    url: http://ports.ubuntu.com/ubuntu-ports

plugs:
  load-rt:
    interface: kernel-module-load
    modules:
    - name: 8723ds
      load: on-boot

parts:
  # Provide the kernel.
  # Trimming any modules we know a priori to not be needed by the target device
  # can reduce kernel snap size.
  kernel:
    plugin: kernel
    source: https://git.launchpad.net/~canonical-kernel/ubuntu/+source/linux-riscv/+git/noble
    source-depth: 1
    source-type: git
    kernel-kconfigflavour: generic
    kernel-kconfigs:
      # Remove all unneeded DRM drivers
      - CONFIG_DRM_AMDGPU=n
      - CONFIG_DRM_KOMEDA=n
      - CONFIG_DRM_NOUVEAU=n
      - CONFIG_DRM_RADEON=n
      - CONFIG_DRM_XE=n
      # Remove all unneeded ethernet drivers
      - CONFIG_ALTERA_TSE=n
      - CONFIG_NET_VENDOR=BROADCOM=n
      - CONFIG_NET_VENDOR_3COM=n
      - CONFIG_NET_VENDOR_8390=n
      - CONFIG_NET_VENDOR_ACTIONS=n
      - CONFIG_NET_VENDOR_ADAPTEC=n
      - CONFIG_NET_VENDOR_ADI=n
      - CONFIG_NET_VENDOR_AGERE=n
      - CONFIG_NET_VENDOR_ALACRITECH=n
      - CONFIG_NET_VENDOR_ALLWINNER=n
      - CONFIG_NET_VENDOR_ALTEON=n
      - CONFIG_NET_VENDOR_AMAZON=n
      - CONFIG_NET_VENDOR_AMD=n
      - CONFIG_NET_VENDOR_APPLE=n
      - CONFIG_NET_VENDOR_AQUANTIA=n
      - CONFIG_NET_VENDOR_ARC=n
      - CONFIG_NET_VENDOR_ASIX=n
      - CONFIG_NET_VENDOR_ATHEROS=n
      - CONFIG_NET_VENDOR_BROADCOM=n
      - CONFIG_NET_VENDOR_BROCADE=n
      - CONFIG_NET_VENDOR_CADENCE=n
      - CONFIG_NET_VENDOR_CAVIUM=n
      - CONFIG_NET_VENDOR_CHELSIO=n
      - CONFIG_NET_VENDOR_CHELSIO=n
      - CONFIG_NET_VENDOR_CIRRUS=n
      - CONFIG_NET_VENDOR_CISCO=n
      - CONFIG_NET_VENDOR_CORTINA=n
      - CONFIG_NET_VENDOR_DAVICOM=n
      - CONFIG_NET_VENDOR_DEC=n
      - CONFIG_NET_VENDOR_DLINK=n
      - CONFIG_NET_VENDOR_EMULEX=n
      - CONFIG_NET_VENDOR_EMULEX=n
      - CONFIG_NET_VENDOR_ENGLEDER=n
      - CONFIG_NET_VENDOR_EZCHIP=n
      - CONFIG_NET_VENDOR_FARADAY=n
      - CONFIG_NET_VENDOR_FREESCALE=n
      - CONFIG_NET_VENDOR_FUJITSU=n
      - CONFIG_NET_VENDOR_FUNGIBLE=n
      - CONFIG_NET_VENDOR_GOOGLE=n
      - CONFIG_NET_VENDOR_HISILICON=n
      - CONFIG_NET_VENDOR_HUAWEI=n
      - CONFIG_NET_VENDOR_I825XX=n
      - CONFIG_NET_VENDOR_IBM=n
      - CONFIG_NET_VENDOR_INTEL=n
      - CONFIG_NET_VENDOR_LITEX=n
      - CONFIG_NET_VENDOR_MARVELL=n
      - CONFIG_NET_VENDOR_MEDIATEK=n
      - CONFIG_INFINIBAND=n
      - CONFIG_NET_VENDOR_MELLANOX=n
      - CONFIG_MLX4_INFINIBAND=n
      - CONFIG_MLX5_INFINIBAND=n
      - CONFIG_NET_VENDOR_MICREL=n
      - CONFIG_NET_VENDOR_MICROCHIP=n
      - CONFIG_NET_VENDOR_MICROSEMI=n
      - CONFIG_NET_VENDOR_MICROSOFT=n
      - CONFIG_NET_VENDOR_MOXART=n
      - CONFIG_NET_VENDOR_MYRI=n
      - CONFIG_NET_VENDOR_NATSEMI=n
      - CONFIG_NET_VENDOR_NETERION=n
      - CONFIG_NET_VENDOR_NETRONOME=n
      - CONFIG_NET_VENDOR_NI=n
      - CONFIG_NET_VENDOR_NVIDIA=n
      - CONFIG_NET_VENDOR_OKI=n
      - CONFIG_NET_VENDOR_PACKET_ENGINES=n
      - CONFIG_NET_VENDOR_PASEMI=n
      - CONFIG_NET_VENDOR_PENSANDO=n
      - CONFIG_NET_VENDOR_QLOGIC=n
      - CONFIG_NET_VENDOR_QUALCOMM=n
      - CONFIG_NET_VENDOR_RDC=n
      - CONFIG_NET_VENDOR_REALTEK=n
      - CONFIG_NET_VENDOR_RENESAS=n
      - CONFIG_NET_VENDOR_ROCKER=n
      - CONFIG_NET_VENDOR_SAMSUNG=n
      - CONFIG_NET_VENDOR_SEEQ=n
      - CONFIG_NET_VENDOR_SGI=n
      - CONFIG_NET_VENDOR_SILAN=n
      - CONFIG_NET_VENDOR_SIS=n
      - CONFIG_NET_VENDOR_SMSC=n
      - CONFIG_NET_VENDOR_SOCIONEXT=n
      - CONFIG_NET_VENDOR_SOLARFLARE=n
      - CONFIG_NET_VENDOR_STMICRO=n
      - CONFIG_NET_VENDOR_SUN=n
      - CONFIG_NET_VENDOR_SUNPLUS=n
      - CONFIG_NET_VENDOR_SYNOPSYS=n
      - CONFIG_NET_VENDOR_TEHUTI=n
      - CONFIG_NET_VENDOR_TI=n
      - CONFIG_NET_VENDOR_TOSHIBA=n
      - CONFIG_NET_VENDOR_TUNDRA=n
      - CONFIG_NET_VENDOR_VERTEXCOM=n
      - CONFIG_NET_VENDOR_VIA=n
      - CONFIG_NET_VENDOR_WANGXUN=n
      - CONFIG_NET_VENDOR_WIZNET=n
      - CONFIG_NET_VENDOR_XILINX=n
      - CONFIG_NET_VENDOR_XIRCOM=n
      - CONFIG_NET_VENDOR_XSCALE=n
      # Remove all unneeded WLAN drivers
      - CONFIG_RTL8180=n
      - CONFIG_RTL8187=n
      - CONFIG_RTL8188EE=n
      - CONFIG_RTL8192CE=n
      - CONFIG_RTL8192CU=n
      - CONFIG_RTL8192C_COMMON=n
      - CONFIG_RTL8192DE=n
      - CONFIG_RTL8192EE=n
      - CONFIG_RTL8192SE=n
      - CONFIG_RTL8723AE=n
      - CONFIG_RTL8723BE=n
      - CONFIG_RTL8723_COMMON=n
      - CONFIG_RTL8821AE=n
      - CONFIG_RTL8XXXU=n
      - CONFIG_RTLBTCOEXIST=n
      - CONFIG_RTLWIFI=n
      - CONFIG_RTLWIFI=n
      - CONFIG_RTLWIFI_PCI=n
      - CONFIG_RTLWIFI_USB=n
      - CONFIG_RTL_CARDS=n
      - CONFIG_RTW88_8723DE=n
      - CONFIG_RTW88_8723DU=n
      - CONFIG_RTW88_8821C=n
      - CONFIG_RTW88_8821CE=n
      - CONFIG_RTW88_8821CS=n
      - CONFIG_RTW88_8821CU=n
      - CONFIG_RTW88_8822B=n
      - CONFIG_RTW88_8822BE=n
      - CONFIG_RTW88_8822BS=n
      - CONFIG_RTW88_8822BU=n
      - CONFIG_RTW88_8822C=n
      - CONFIG_RTW88_8822CE=n
      - CONFIG_RTW88_8822CS=n
      - CONFIG_RTW88_8822CU=n
      - CONFIG_RTW88_DEBUG=n
      - CONFIG_RTW88_DEBUGFS=n
      - CONFIG_RTW88_PCI=n
      - CONFIG_RTW88_USB=n
      - CONFIG_RTW89=n
      - CONFIG_WLAN_VENDOR_ADMTEK=n
      - CONFIG_WLAN_VENDOR_ATH=n
      - CONFIG_WLAN_VENDOR_ATMEL=n
      - CONFIG_WLAN_VENDOR_BROADCOM=n
      - CONFIG_WLAN_VENDOR_INTEL=n
      - CONFIG_WLAN_VENDOR_INTERSIL=n
      - CONFIG_WLAN_VENDOR_MARVELL=n
      - CONFIG_WLAN_VENDOR_MEDIATEK=n
      - CONFIG_WLAN_VENDOR_MICROCHIP=n
      - CONFIG_WLAN_VENDOR_PURELIFI=n
      - CONFIG_WLAN_VENDOR_QUANTENNA=n
      - CONFIG_WLAN_VENDOR_RALINK=n
      - CONFIG_WLAN_VENDOR_RSI=n
      - CONFIG_WLAN_VENDOR_SILABS=n
      - CONFIG_WLAN_VENDOR_ST=n
      - CONFIG_WLAN_VENDOR_TI=n
      - CONFIG_WLAN_VENDOR_ZYDAS=n
      # Remove all unneeded bluetooth drivers
      - CONFIG_BT_INTEL=n
      - CONFIG_BT_BCM=n
      - CONFIG_BT_QCA=n
      - CONFIG_BT_MTK=n
      - CONFIG_BT_HCIBTUSB=n
      - CONFIG_BT_HCIBTUSB_AUTOSUSPEND=n
      - CONFIG_BT_HCIBTUSB_POLL_SYNC=n
      - CONFIG_BT_HCIBTUSB_BCM=n
      - CONFIG_BT_HCIBTUSB_MTK=n
      - CONFIG_BT_HCIBTUSB_RTL=n
      - CONFIG_BT_HCIBTSDIO=n
      - CONFIG_BT_HCIUART=n
      - CONFIG_BT_HCIUART_SERDEV=n
      - CONFIG_BT_HCIUART_H4=n
      - CONFIG_BT_HCIUART_NOKIA=n
      - CONFIG_BT_HCIUART_BCSP=n
      - CONFIG_BT_HCIUART_ATH3K=n
      - CONFIG_BT_HCIUART_LL=n
      - CONFIG_BT_HCIUART_3WIRE=n
      - CONFIG_BT_HCIUART_INTEL=n
      - CONFIG_BT_HCIUART_BCM=n
      - CONFIG_BT_HCIUART_RTL=n
      - CONFIG_BT_HCIUART_QCA=n
      - CONFIG_BT_HCIUART_AG6XX=n
      - CONFIG_BT_HCIUART_MRVL=n
      - CONFIG_BT_HCIBCM203X=n
      - CONFIG_BT_HCIBCM4377=n
      - CONFIG_BT_HCIBPA10X=n
      - CONFIG_BT_HCIBFUSB=n
      - CONFIG_BT_HCIVHCI=n
      - CONFIG_BT_MRVL=n
      - CONFIG_BT_MRVL_SDIO=n
      - CONFIG_BT_ATH3K=n
      - CONFIG_BT_MTKSDIO=n
      - CONFIG_BT_MTKUART=n
      - CONFIG_BT_VIRTIO=n
      - CONFIG_BT_NXPUART=n
      # Remove all unneeded NFC drivers
      - CONFIG_NFC_TRF7970A=n
      - CONFIG_NFC_SIM=n
      - CONFIG_NFC_PORT100=n
      - CONFIG_NFC_VIRTUAL_NCI=n
      - CONFIG_NFC_FDP=n
      - CONFIG_NFC_FDP_I2C=n
      - CONFIG_NFC_PN544=n
      - CONFIG_NFC_PN544_I2C=n
      - CONFIG_NFC_PN533=n
      - CONFIG_NFC_PN533_USB=n
      - CONFIG_NFC_PN533_I2C=n
      - CONFIG_NFC_PN532_UART=n
      - CONFIG_NFC_MICROREAD=n
      - CONFIG_NFC_MICROREAD_I2C=n
      - CONFIG_NFC_MRVL=n
      - CONFIG_NFC_MRVL_USB=n
      - CONFIG_NFC_MRVL_UART=n
      - CONFIG_NFC_MRVL_I2C=n
      - CONFIG_NFC_MRVL_SPI=n
      - CONFIG_NFC_ST21NFCA=n
      - CONFIG_NFC_ST21NFCA_I2C=n
      - CONFIG_NFC_ST_NCI=n
      - CONFIG_NFC_ST_NCI_I2C=n
      - CONFIG_NFC_ST_NCI_SPI=n
      - CONFIG_NFC_NXP_NCI=n
      - CONFIG_NFC_NXP_NCI_I2C=n
      - CONFIG_NFC_S3FWRN5=n
      - CONFIG_NFC_S3FWRN5_I2C=n
      - CONFIG_NFC_S3FWRN82_UART=n
      - CONFIG_NFC_ST95HF=n
      # Remove all unneeded PCIe controllers
      - CONFIG_PCIE_DW=n
      - CONFIG_PCIE_DW_HOST=n
      - CONFIG_PCIE_DW_EP=n
      - CONFIG_PCIE_DW_PLAT=n
      - CONFIG_PCIE_DW_PLAT_HOST=n
      - CONFIG_PCIE_DW_PLAT_EP=n
      - CONFIG_PCIE_RCAR_GEN4=n
      - CONFIG_PCIE_RCAR_GEN4_HOST=n
      - CONFIG_PCIE_RCAR_GEN4_EP=n
      - CONFIG_PCIE_FU740=n
      - CONFIG_PCIE_PLDA_HOST=n
      - CONFIG_PCIE_MICROCHIP_HOST=n
      - CONFIG_PCIE_STARFIVE_HOST=n
      # Remove all unneeded RapidIO drivers
      - CONFIG_RAPIDIO_CPS_XX=n
      - CONFIG_RAPIDIO_CPS_GEN2=n
      - CONFIG_RAPIDIO_RXS_GEN3=n
      # Remove GNSS
      - CONFIG_GNSS=n
      - CONFIG_GNSS_SERIAL=n
      - CONFIG_GNSS_MTK_SERIAL=n
      - CONFIG_GNSS_SIRF_SERIAL=n
      - CONFIG_GNSS_UBX_SERIAL=n
      - CONFIG_GNSS_USB=n
      - CONFIG_MTD=n
      # Remove SCSI, ATA support
      - CONFIG_SCSI_MOD=n
      - CONFIG_RAID_ATTRS=n
      - CONFIG_SCSI_COMMON=n
      - CONFIG_SCSI=n
      - CONFIG_SCSI_DMA=n
      - CONFIG_SCSI_NETLINK=n
      - CONFIG_SCSI_PROC_FS=n
      - CONFIG_BLK_DEV_SD=n
      - CONFIG_CHR_DEV_ST=n
      - CONFIG_BLK_DEV_SR=n
      - CONFIG_CHR_DEV_SG=n
      - CONFIG_BLK_DEV_BSG=n
      - CONFIG_CHR_DEV_SCH=n
      - CONFIG_SCSI_ENCLOSURE=n
      - CONFIG_SCSI_CONSTANTS=n
      - CONFIG_SCSI_LOGGING=n
      - CONFIG_SCSI_SCAN_ASYNC=n
      - CONFIG_SCSI_SPI_ATTRS=n
      - CONFIG_SCSI_FC_ATTRS=n
      - CONFIG_SCSI_ISCSI_ATTRS=n
      - CONFIG_SCSI_SAS_ATTRS=n
      - CONFIG_SCSI_SAS_LIBSAS=n
      - CONFIG_SCSI_SAS_ATA=n
      - CONFIG_SCSI_SAS_HOST_SMP=n
      - CONFIG_SCSI_SRP_ATTRS=n
      - CONFIG_SCSI_LOWLEVEL=n
      - CONFIG_ISCSI_TCP=n
      - CONFIG_ISCSI_BOOT_SYSFS=n
      - CONFIG_SCSI_CXGB3_ISCSI=n
      - CONFIG_SCSI_CXGB4_ISCSI=n
      - CONFIG_SCSI_BNX2_ISCSI=n
      - CONFIG_SCSI_BNX2X_FCOE=n
      - CONFIG_BE2ISCSI=n
      - CONFIG_BLK_DEV_3W_XXXX_RAID=n
      - CONFIG_SCSI_HPSA=n
      - CONFIG_SCSI_3W_9XXX=n
      - CONFIG_SCSI_3W_SAS=n
      - CONFIG_SCSI_ACARD=n
      - CONFIG_SCSI_AACRAID=n
      - CONFIG_SCSI_AIC7XXX=n
      - CONFIG_AIC7XXX_CMDS_PER_DEVICE=n
      - CONFIG_AIC7XXX_DEBUG_MASK=n
      - CONFIG_AIC7XXX_REG_PRETTY_PRINT=n
      - CONFIG_SCSI_AIC94XX=n
      - CONFIG_SCSI_MVSAS=n
      - CONFIG_SCSI_MVUMI=n
      - CONFIG_SCSI_ADVANSYS=n
      - CONFIG_SCSI_ARCMSR=n
      - CONFIG_SCSI_ESAS2R=n
      - CONFIG_MEGARAID_NEWGEN=n
      - CONFIG_MEGARAID_MM=n
      - CONFIG_MEGARAID_MAILBOX=n
      - CONFIG_MEGARAID_LEGACY=n
      - CONFIG_MEGARAID_SAS=n
      - CONFIG_SCSI_MPT3SAS=n
      - CONFIG_SCSI_MPT2SAS_MAX_SGE=n
      - CONFIG_SCSI_MPT3SAS_MAX_SGE=n
      - CONFIG_SCSI_MPT2SAS=n
      - CONFIG_SCSI_MPI3MR=n
      - CONFIG_SCSI_SMARTPQI=n
      - CONFIG_SCSI_HPTIOP=n
      - CONFIG_SCSI_BUSLOGIC=n
      - CONFIG_SCSI_FLASHPOINT=n
      - CONFIG_SCSI_MYRB=n
      - CONFIG_SCSI_MYRS=n
      - CONFIG_LIBFC=n
      - CONFIG_LIBFCOE=n
      - CONFIG_FCOE=n
      - CONFIG_SCSI_SNIC=n
      - CONFIG_SCSI_DMX3191D=n
      - CONFIG_SCSI_FDOMAIN=n
      - CONFIG_SCSI_FDOMAIN_PCI=n
      - CONFIG_SCSI_IPS=n
      - CONFIG_SCSI_INITIO=n
      - CONFIG_SCSI_INIA100=n
      - CONFIG_SCSI_PPA=n
      - CONFIG_SCSI_IMM=n
      - CONFIG_SCSI_STEX=n
      - CONFIG_SCSI_SYM53C8XX_2=n
      - CONFIG_SCSI_SYM53C8XX_DMA_ADDRESSING_MODE=n
      - CONFIG_SCSI_SYM53C8XX_DEFAULT_TAGS=n
      - CONFIG_SCSI_SYM53C8XX_MAX_TAGS=n
      - CONFIG_SCSI_SYM53C8XX_MMIO=n
      - CONFIG_SCSI_IPR=n
      - CONFIG_SCSI_IPR_TRACE=n
      - CONFIG_SCSI_IPR_DUMP=n
      - CONFIG_SCSI_QLOGIC_1280=n
      - CONFIG_SCSI_QLA_FC=n
      - CONFIG_TCM_QLA2XXX=n
      - CONFIG_SCSI_QLA_ISCSI=n
      - CONFIG_SCSI_LPFC=n
      - CONFIG_SCSI_EFCT=n
      - CONFIG_SCSI_DC395x=n
      - CONFIG_SCSI_AM53C974=n
      - CONFIG_SCSI_WD719X=n
      - CONFIG_SCSI_DEBUG=n
      - CONFIG_SCSI_PMCRAID=n
      - CONFIG_SCSI_PM8001=n
      - CONFIG_SCSI_BFA_FC=n
      - CONFIG_SCSI_VIRTIO=n
      - CONFIG_SCSI_CHELSIO_FCOE=n
      - CONFIG_SCSI_DH=n
      - CONFIG_SCSI_DH_RDAC=n
      - CONFIG_SCSI_DH_HP_SW=n
      - CONFIG_SCSI_DH_EMC=n
      - CONFIG_SCSI_DH_ALUA=n
      - CONFIG_ATA=n
      - CONFIG_SATA_HOST=n
      - CONFIG_PATA_TIMINGS=n
      - CONFIG_ATA_VERBOSE_ERROR=n
      - CONFIG_ATA_FORCE=n
      - CONFIG_ATA_ACPI=n
      - CONFIG_SATA_ZPODD=n
      - CONFIG_SATA_PMP=n
      # Remove SFF
      - CONFIG_PDC_ADMA=n
      - CONFIG_SATA_QSTOR=n
      - CONFIG_SATA_SX4=n
      - CONFIG_ATA_BMDMA=n
      - CONFIG_ATA_PIIX=n
      - CONFIG_SATA_DWC=n
      - CONFIG_SATA_DWC_OLD_DMA=n
      - CONFIG_SATA_MV=n
      - CONFIG_SATA_NV=n
      - CONFIG_SATA_PROMISE=n
      - CONFIG_SATA_RCAR=n
      - CONFIG_SATA_SIL=n
      - CONFIG_SATA_SIS=n
      - CONFIG_SATA_SVW=n
      - CONFIG_SATA_ULI=n
      - CONFIG_SATA_VIA=n
      - CONFIG_SATA_VITESSE=n
      - CONFIG_PATA_ALI=n
      - CONFIG_PATA_AMD=n
      - CONFIG_PATA_ARTOP=n
      - CONFIG_PATA_ATIIXP=n
      - CONFIG_PATA_ATP867X=n
      - CONFIG_PATA_CMD64X=n
      - CONFIG_PATA_CYPRESS=n
      - CONFIG_PATA_EFAR=n
      - CONFIG_PATA_HPT366=n
      - CONFIG_PATA_HPT37X=n
      - CONFIG_PATA_HPT3X2N=n
      - CONFIG_PATA_HPT3X3=n
      - CONFIG_PATA_IT8213=n
      - CONFIG_PATA_IT821X=n
      - CONFIG_PATA_JMICRON=n
      - CONFIG_PATA_MARVELL=n
      - CONFIG_PATA_NETCELL=n
      - CONFIG_PATA_NINJA32=n
      - CONFIG_PATA_NS87415=n
      - CONFIG_PATA_OLDPIIX=n
      - CONFIG_PATA_OPTIDMA=n
      - CONFIG_PATA_PDC2027X=n
      - CONFIG_PATA_PDC_OLD=n
      - CONFIG_PATA_RADISYS=n
      - CONFIG_PATA_RDC=n
      - CONFIG_PATA_SCH=n
      - CONFIG_PATA_SERVERWORKS=n
      - CONFIG_PATA_SIL680=n
      - CONFIG_PATA_SIS=n
      - CONFIG_PATA_TOSHIBA=n
      - CONFIG_PATA_TRIFLEX=n
      - CONFIG_PATA_VIA=n
      - CONFIG_PATA_WINBOND=n
      - CONFIG_PATA_CMD640_PCI=n
      - CONFIG_PATA_MPIIX=n
      - CONFIG_PATA_NS87410=n
      - CONFIG_PATA_OPTI=n
      - CONFIG_PATA_PLATFORM=n
      - CONFIG_PATA_OF_PLATFORM=n
      - CONFIG_PATA_RZ1000=n
      - CONFIG_PATA_PARPORT=n
      # Remove PATA
      - CONFIG_PATA_PARPORT_ATEN=n
      - CONFIG_PATA_PARPORT_BPCK=n
      - CONFIG_PATA_PARPORT_BPCK6=n
      - CONFIG_PATA_PARPORT_COMM=n
      - CONFIG_PATA_PARPORT_DSTR=n
      - CONFIG_PATA_PARPORT_FIT2=n
      - CONFIG_PATA_PARPORT_FIT3=n
      - CONFIG_PATA_PARPORT_EPAT=n
      - CONFIG_PATA_PARPORT_EPATC8=n
      - CONFIG_PATA_PARPORT_EPIA=n
      - CONFIG_PATA_PARPORT_FRIQ=n
      - CONFIG_PATA_PARPORT_FRPW=n
      - CONFIG_PATA_PARPORT_KBIC=n
      - CONFIG_PATA_PARPORT_KTTI=n
      - CONFIG_PATA_PARPORT_ON20=n
      - CONFIG_PATA_PARPORT_ON26=n
      # Remove Firewire
      - CONFIG_FIREWIRE=n
      # The LicheeRV uses the mainlined 8723ds module
      # The Nezha uses an XR829, not currently available
      - CONFIG_RTW88_SDIO=m
      - CONFIG_RTW88_8723D=m
      - CONFIG_RTW88_8723DS=m
    build-packages:
      - on riscv64:
        - gcc
      - on amd64:
        - gcc-${CRAFT_ARCH_TRIPLET_BUILD_FOR}
    stage-packages:
      - linux-firmware:${CRAFT_ARCH_BUILD_FOR}
      - wireless-regdb
    override-build: |
      # Ensure the symlink the kernel plugin creates doesn't annihilate the
      # firmware files This directory will exist because linux-firmware is
      # unpacked before the plugin's default behavior runs
      [ -e "${CRAFT_PART_INSTALL}/firmware" ] || {
        mv -f "${CRAFT_PART_INSTALL}/lib/firmware" "${CRAFT_PART_INSTALL}/firmware"
      }

      craftctl default

      kver="$(basename "${CRAFT_PART_INSTALL}/lib/modules/"*)"

      # Set the version of the snap to match the kernel version.
      craftctl set version="$kver"

      # Organize does not respect variables set in an override build, so in
      # order to preserve the directory structure without manual intervention we
      # have to move the modules ourselves
      for mod in "${CRAFT_PART_INSTALL}/modules/${kver}/kernel/drivers/net/wireless/realtek/rtw88/"*.ko; do
        install -Dm644 "$mod" "${CRAFT_COMPONENT_WLAN_PRIME}/${mod##*/install}"
      done

      # Install the relevant license files
      install -Dm644 "${CRAFT_PART_SRC}/LICENSES/preferred/GPL-2.0" \
                     "${CRAFT_PART_INSTALL}/LICENSE"
      install -Dm644 "${CRAFT_PART_SRC}/LICENSES/exceptions/Linux-syscall-note" \
                     "${CRAFT_PART_INSTALL}/LICENSE.exception"
    organize:
      LICENSE: licenses/kernel.license
      LICENSE.exception: licenses/kernel.license-exception
      dtbs/allwinner: dtbs/
      firmware/rtw88/: (component/wlan)/firmware/rtw88/rtw8723d_fw.bin.zst
    stage:
      - System.map-*
      - config-*
      - dtbs/sun20i-d1-lichee-rv-86-panel-480p.dtb
      - dtbs/sun20i-d1-lichee-rv-86-panel-720p.dtb
      - dtbs/sun20i-d1-lichee-rv-dock.dtb
      - dtbs/sun20i-d1-lichee-rv.dtb
      - dtbs/sun20i-d1-nezha.dtb
      - kernel.img
      - firmware/
      - lib/
      - licenses/
      - modules/
    prime:
      - -kernel.img

  # Trimming any firmware we know a priori to not be needed by the target device
  # can reduce kernel snap size.
  trim-firmware:
    plugin: dump
    after: [kernel]
    source: https://git.launchpad.net/canonical-kernel-snaps
    source-depth: 1
    source-type: git
    stage:
      - trim-firmware
    override-prime: |
      craftctl default
      "${CRAFT_STAGE}/trim-firmware" "${CRAFT_PRIME}"
    prime:
      - -*

  # Provide the initrd for Ubuntu Core.
  # The initrd includes important things such as snap-bootstrap which
  # orchestrates the entire Ubuntu Core installation process. The documentation
  # for this tool can be found here:
  # https://github.com/snapcore/snapd/blob/master/cmd/snap-bootstrap/README.md
  initrd:
    plugin: initrd
    after: [kernel]
    initrd-build-efi-image: true
    initrd-configured-modules: [8723ds, nls_iso8859-1, sunxi-mmc]
    build-snaps: [core24/latest/stable]
    prime:
      - -kernel.efi-*

components:
  wlan:
    type: kernel-modules
    # It would be nice if the component version could be set by the kernel part.
    # This version string may (probably will) fall out of sync.
    version: 6.8.0-generic
    summary: The Realtek 8723ds WiFi module and firmware
    description: |
      The 8723ds Realtek WiFi kernel module used by the Sipeed LicheeRV. This
      module is useless on the Nezha board which also uses this kernel. To save
      on some small disk space, we package this module separately.
